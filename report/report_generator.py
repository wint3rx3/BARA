from jinja2 import Environment, FileSystemLoader
from weasyprint import HTML
import os

TEMPLATE_DIR = os.path.dirname(__file__)

KOR_LABELS = {
    "history": "ì—°í˜",
    "address": "ì£¼ì†Œ",
    "welfare": "ë³µì§€",
    "greeting": "ì‹ ë…„ì‚¬",
    "talent": "ì¸ì¬ìƒ",
    "website": "ì±„ìš©ì‚¬ì´íŠ¸",
    "business": "ì‚¬ì—…ë‚´ìš©",
    "employees": "ì§ì›ìˆ˜",
    "entry_salary": "ì‹ ì…ì‚¬ì› ì´ˆë´‰",
    "avg_salary": "í‰ê· ì—°ë´‰"
}

def generate_pdf(state: dict, output_path: str = "output_report.pdf"):
    env = Environment(loader=FileSystemLoader(TEMPLATE_DIR))
    template = env.get_template("default_report.html")

    print("ğŸ’¡ stock_chart_path:", state.get("finance_result", {}).get("output", {}).get("stock_chart_path"))
    print("ğŸ’¡ revenue_chart_path:", state.get("finance_result", {}).get("output", {}).get("revenue_chart_path"))

    interview_result = state.get("interview_result", {}).get("output", {}) or {}
    resume_output = state.get("resume_result", {}).get("output", {}) or {}

    # âœ… ì¸ì„± ì§ˆë¬¸ ì œê±°
    interview_qna = {
        k: v for k, v in interview_result.items()
        if k not in ["summary", "ì¸ì„± ì§ˆë¬¸", "ì§ë¬´ ì§ˆë¬¸"]
    }

    # âœ… ì‹¤ì œ ë‚´ìš©ì´ ìˆëŠ” ì—­ëŸ‰ë§Œ ì¶”ë¦¼
    raw_interview_hard = {
        "ì ì¬ì—­ëŸ‰": interview_result.get("potential", {}),
        "ì¡°ì§ê´€ê³„ì—­ëŸ‰": interview_result.get("communication", {}),
        "ì§ë¬´ì—­ëŸ‰": interview_result.get("competency", {}),
        "ì¸ì„±ì—­ëŸ‰": interview_result.get("personality", {}),
    }
    interview_hard = {
        k: v for k, v in raw_interview_hard.items()
        if isinstance(v, dict) and any(val for val in v.values() if isinstance(val, str) and val.strip())
    }

    html = template.render(
        ê¸°ì—…ëª…=state["user_input"].get("ê¸°ì—…ëª…", ""),
        ì§ë¬´ëª…=state["user_input"].get("ì§ë¬´ëª…", ""),

        finance=state.get("finance_result", {}).get("output", {}),
        news_list=state.get("news_result", {}).get("output", {}).get("articles", []),

        resume=resume_output,
        profile_comparison=resume_output.get("profile_comparison", []),
        jd_alignment=resume_output.get("jd_alignment", {}),
        philosophy_alignment=resume_output.get("philosophy_alignment", {}),

        interview_summary=interview_result.get("summary", {}),
        interview_qna=interview_qna,
        interview_hard=interview_hard,  # âœ… ë¹„ì–´ìˆì§€ ì•Šì€ í•­ëª©ë§Œ í¬í•¨

        company_info=state.get("company_info_result", {}).get("output", {}),
        company_info_labels=KOR_LABELS
    )

    HTML(string=html).write_pdf(output_path)
    print(f"ğŸ“„ PDF ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ â†’ {output_path}")
